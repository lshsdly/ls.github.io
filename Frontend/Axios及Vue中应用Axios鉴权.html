<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Axios 及 Vue 中应用 Axios 鉴权 | Better than never</title>
    <meta name="description" content="梁的个人网站">
    <link rel="icon" href="/logo.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.80698cd3.css" as="style"><link rel="preload" href="/assets/js/app.aa07e3f0.js" as="script"><link rel="preload" href="/assets/js/2.3c3a8b86.js" as="script"><link rel="preload" href="/assets/js/11.087b2c37.js" as="script"><link rel="prefetch" href="/assets/js/10.16485189.js"><link rel="prefetch" href="/assets/js/12.1232ddd6.js"><link rel="prefetch" href="/assets/js/13.d08737f4.js"><link rel="prefetch" href="/assets/js/14.5400c51f.js"><link rel="prefetch" href="/assets/js/15.6e20fcc4.js"><link rel="prefetch" href="/assets/js/16.8f188508.js"><link rel="prefetch" href="/assets/js/17.31b200b9.js"><link rel="prefetch" href="/assets/js/18.09631d42.js"><link rel="prefetch" href="/assets/js/19.ea1c561c.js"><link rel="prefetch" href="/assets/js/20.7e1fbe74.js"><link rel="prefetch" href="/assets/js/21.6a57e774.js"><link rel="prefetch" href="/assets/js/22.0b5e3d00.js"><link rel="prefetch" href="/assets/js/23.c0b1a40b.js"><link rel="prefetch" href="/assets/js/24.6aaf1c96.js"><link rel="prefetch" href="/assets/js/25.52f988b5.js"><link rel="prefetch" href="/assets/js/26.ca333bb8.js"><link rel="prefetch" href="/assets/js/27.c6dae7fd.js"><link rel="prefetch" href="/assets/js/28.5e816cc0.js"><link rel="prefetch" href="/assets/js/3.1a056928.js"><link rel="prefetch" href="/assets/js/4.1ae91333.js"><link rel="prefetch" href="/assets/js/5.9279dd66.js"><link rel="prefetch" href="/assets/js/6.5e5f6408.js"><link rel="prefetch" href="/assets/js/7.a81f715f.js"><link rel="prefetch" href="/assets/js/8.d07cfd7b.js"><link rel="prefetch" href="/assets/js/9.b0483dea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.80698cd3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Better than never</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Frontend/" class="nav-link router-link-active">前端相关</a></div><div class="nav-item"><a href="/resume.html" class="nav-link">个人简历</a></div><div class="nav-item"><a href="/Tools.html" class="nav-link">工具资源（待）</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Frontend/" class="nav-link router-link-active">前端相关</a></div><div class="nav-item"><a href="/resume.html" class="nav-link">个人简历</a></div><div class="nav-item"><a href="/Tools.html" class="nav-link">工具资源（待）</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Axios 及 Vue 中应用 Axios 鉴权</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#基本使用" class="sidebar-link">基本使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#post-请求" class="sidebar-link">POST 请求</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#get-请求" class="sidebar-link">GET 请求</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#获取返回数据" class="sidebar-link">获取返回数据</a></li></ul></li><li><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#全局请求配置" class="sidebar-link">全局请求配置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#拦截器" class="sidebar-link">拦截器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#添加" class="sidebar-link">添加</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#移除" class="sidebar-link">移除</a></li></ul></li><li><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#自定义-axios-实例" class="sidebar-link">自定义 axios 实例</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#authentication-鉴权" class="sidebar-link">Authentication 鉴权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#单页应用鉴权原理" class="sidebar-link">单页应用鉴权原理</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#登录使用" class="sidebar-link">登录使用</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#vuex-令牌存储" class="sidebar-link">vuex 令牌存储</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#在需要鉴权的位置使用-vuex-存储的令牌" class="sidebar-link">在需要鉴权的位置使用 vuex 存储的令牌</a></li><li class="sidebar-sub-header"><a href="/Frontend/Axios%E5%8F%8AVue%E4%B8%AD%E5%BA%94%E7%94%A8Axios%E9%89%B4%E6%9D%83.html#访问控制-路由保护" class="sidebar-link">访问控制 / 路由保护</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="axios-及-vue-中应用-axios-鉴权"><a href="#axios-及-vue-中应用-axios-鉴权" aria-hidden="true" class="header-anchor">#</a> Axios 及 Vue 中应用 Axios 鉴权</h1> <blockquote><p>2019/8/24</p></blockquote> <p>用于在 Javascript 项目中创建 HTTP 请求。</p> <p>Axios 是独立的包，没有整合在 Vue 中，有的包可以把 axios 绑定到 Vue，然后在实例或组件中通过关键字获取到它。</p> <h2 id="基本使用"><a href="#基本使用" aria-hidden="true" class="header-anchor">#</a> 基本使用</h2> <ul><li><p>axios 会返回一个 <strong>promise</strong>，当 promise 被 resolve 时用 <strong>then 方法</strong>处理数据。</p> <ul><li>因为发送 POST 请求是异步操作，可能在未来某个时间点再对结果做出反应。</li> <li>then 处创建函数，在请求结束时调用</li></ul></li> <li><p>可以设置一个 <strong>catch 块</strong>来捕获潜在错误进行处理。</p></li></ul> <h3 id="post-请求"><a href="#post-请求" aria-hidden="true" class="header-anchor">#</a> POST 请求</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> ‘axios'<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">'https://firebaseio.com/user.json'</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">37</span><span class="token punctuation">,</span>
        age<span class="token punctuation">:</span> <span class="token number">13</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="参数"><a href="#参数" aria-hidden="true" class="header-anchor">#</a> 参数</h4> <ol><li>URL（必需）</li> <li>传递数据（必需）</li></ol> <ul><li>axios 会自动把数据转化成字符串，然后发送有效字段给后端</li></ul> <ol start="3"><li>对象</li></ol> <ul><li>可以在里面配置请求</li></ul> <h3 id="get-请求"><a href="#get-请求" aria-hidden="true" class="header-anchor">#</a> GET 请求</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 如果其他组件有导入过相同的内容，再次导入不会增大压缩文件的体积</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> ‘axios'<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">'https://firebaseio.com/user.json'</span><span class="token punctuation">;</span>
    axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="参数-2"><a href="#参数-2" aria-hidden="true" class="header-anchor">#</a> 参数</h4> <ol><li>URL（必需）</li> <li>对象</li></ol> <ul><li>可以在里面配置请求</li></ul> <h3 id="获取返回数据"><a href="#获取返回数据" aria-hidden="true" class="header-anchor">#</a> 获取返回数据</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回的数据格式可能各有不同，根据格式做针对性处理：</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      user<span class="token punctuation">.</span>id <span class="token operator">=</span> key<span class="token punctuation">;</span>  <span class="token comment">// 这样不会丢失 Key</span>
      users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>email <span class="token operator">=</span> user<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>email<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 写在 get 后的代码，会在 get 后立刻执行；</span>
<span class="token comment">// 而对 get 到的数据执行的操作是异步的，会在未来的某个时间点执行，因此只能在 then 中进行操作。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="全局请求配置"><a href="#全局请求配置" aria-hidden="true" class="header-anchor">#</a> 全局请求配置</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// main.js: 组件代码前执行的第一个文件</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> axios<span class="token punctuation">;</span>
<span class="token comment">// 也可以把 axios 的逻辑放置在单独的文件导入</span>

<span class="token comment">// 配置一些参数，这些参数也可在请求中单独配置</span>
<span class="token comment">// baseURL 根地址，之后所有的 axios 的请求 url 都会自动拼接在 baseURL 后面：</span>
axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>baseURL <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token comment">// axios 通常会设置一些默认 Header，在这里设置自己特定的，axios 会自己整合到一起；</span>
<span class="token comment">// 根据不同目的有几个选项：</span>
axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>common<span class="token punctuation">[</span><span class="token string">'Authorization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'fasfdsa'</span><span class="token punctuation">;</span> <span class="token comment">// common 作用于所有请求，不管什么请求方式</span>
axois<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">[</span><span class="token string">'Accepts'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'application'</span><span class="token punctuation">;</span> <span class="token comment">// 只针对 get 请求</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="拦截器"><a href="#拦截器" aria-hidden="true" class="header-anchor">#</a> 拦截器</h2> <p>拦截器是一个可以定义的<strong>函数</strong>，在请求离开应用或相应数据返回时执行。</p> <h3 id="添加"><a href="#添加" aria-hidden="true" class="header-anchor">#</a> 添加</h3> <p>拦截器要在 axios 实例的 <strong>interceptors 对象</strong>上操作，根据你想创建的拦截器种类，选择 request 或 response，然后用 use 方法创建拦截器。</p> <h4 id="request"><a href="#request" aria-hidden="true" class="header-anchor">#</a> request</h4> <ul><li>use()
<ul><li>传入参数：<strong>函数</strong> <ul><li>接收请求的配置 config 为参数</li> <li>返回这个 config
<ul><li>不然请求会被阻断</li></ul></li></ul></li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * config.headers['SOMETHING]
   * 可以设置自己的 Header
   * 不用获取 common / get / post，因为这些都是在请求层面的
   */</span>
  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="response"><a href="#response" aria-hidden="true" class="header-anchor">#</a> response</h4> <ul><li>use()
<ul><li>传入参数：<strong>返回的响应</strong></li> <li>返回<strong>该响应</strong> <ul><li>不然等待相应返回的代码会接收不到相应</li></ul></li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>拦截器就是一个中间件，在某些代码之间执行，中途拦截请求或响应。</p></blockquote> <h3 id="移除"><a href="#移除" aria-hidden="true" class="header-anchor">#</a> 移除</h3> <p>拦截器可以被添加，也可以被移除。</p> <ul><li>eject(id)
<ul><li>以拦截器的 id 为参数
<ul><li>该 id 在 use 函数返回</li></ul></li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> reqInterceptor <span class="token operator">=</span> axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token operator">=&gt;</span> <span class="token keyword">return</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resInterceptor <span class="token operator">=</span> axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token keyword">return</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">eject</span><span class="token punctuation">(</span>reqInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
axios<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">eject</span><span class="token punctuation">(</span>resInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="自定义-axios-实例"><a href="#自定义-axios-实例" aria-hidden="true" class="header-anchor">#</a> 自定义 axios 实例</h2> <p>如果应用里用了不同的 URL 请求，有的请求需要鉴权，有的需要...自定义实例可以很好的处理这些问题。</p> <ul><li>create
<ul><li>返回一个新的 axios 实例</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// axios-ins</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axois'</span><span class="token punctuation">;</span>  <span class="token comment">// 在新文件中也需要导入</span>

<span class="token keyword">const</span> instance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  baseURL<span class="token punctuation">:</span> <span class="token string">'https://github.cn'</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义 headers</span>
instance<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>common<span class="token punctuation">[</span><span class="token string">'DEMO'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ‘demo'<span class="token punctuation">;</span> <span class="token comment">// 这个 defaults 只会作用于这个新实例，不会影响全局</span>

<span class="token comment">// 导出</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> instance<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>使用实例：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'./axios-ins'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="authentication-鉴权"><a href="#authentication-鉴权" aria-hidden="true" class="header-anchor">#</a> Authentication 鉴权</h2> <p>鉴权逻辑大部分在后端即服务器上运行，但在单页面应用中，对鉴权的处理比较特殊，需要 Vue 的参与。</p> <h3 id="单页应用鉴权原理"><a href="#单页应用鉴权原理" aria-hidden="true" class="header-anchor">#</a> 单页应用鉴权原理</h3> <p>对于非单页应用，鉴权的工作原理和传统 web 开发相同，在于管理应用与服务器的对话，和 Vue 无关。</p> <p>对于 Vue 写的单页应用，它同样有服务端和运行但页面应用的客户端，也就是浏览器。</p> <p>用户登录或注册时，我们把登录信息发送到服务器，服务器检查信息正确与否，如果数据库有对应用户名和密码，会返回相应的信息。</p> <p>这个信息，在传统网页中是一个对话（session），在单页面应用中，调用的是<strong>无状态的、不记录客户端信息的 Stateless, RESTful API</strong>，它不保存对话，此时服务器传回的不是对话，而是 token 令牌（Token）。</p> <p>Token 会被储存在服务器上，通常是比较长的字符串，可以被解码为 JS 对象，里面存储用户信息、令牌有效性及过期时间等。</p> <p>生成令牌的方法保证了服务器可以验证这个令牌是否是自己生成的，而后判断其真伪。</p> <p>我们将令牌存在前端，也就是浏览器中，如果要从一个 API 获取数据，而这个 API 需要登录，只需随请求发送令牌，我们在本地保存的令牌就作为鉴权的标志，随请求传送给服务器，在服务器上验证。</p> <p>我们在前端存储的令牌，出于安全考虑，仅在很短时间内有效。</p> <h3 id="登录使用"><a href="#登录使用" aria-hidden="true" class="header-anchor">#</a> 登录使用</h3> <blockquote><p>注册中也有使用，注册后会返回 token 和刷新 token 需要的值。</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// firebase</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'https://url.com/verifyPassword?key=mykey'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  email<span class="token punctuation">:</span> formData<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
  password<span class="token punctuation">:</span> formData<span class="token punctuation">.</span>password<span class="token punctuation">,</span>
  returnSecureToken<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="vuex-令牌存储"><a href="#vuex-令牌存储" aria-hidden="true" class="header-anchor">#</a> vuex 令牌存储</h3> <ul><li>vuex</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// store.js</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'Vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'./axios-auth'</span><span class="token punctuation">;</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    idToken<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">authUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>idToken <span class="token operator">=</span> userDate<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>userId <span class="token operator">=</span> userDate<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">signup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>signupUrl<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token comment">// 这段代码在 actions 中，才能使用 vuex 的仓库处理请求</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'authUser'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            token<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>idToken<span class="token punctuation">,</span>  <span class="token comment">// firebase 版</span>
            userId<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>localId
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>loginUrl<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'authUser'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            token<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>idToken<span class="token punctuation">,</span>
            userId<span class="token punctuation">:</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>localId
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="在需要鉴权的位置使用-vuex-存储的令牌"><a href="#在需要鉴权的位置使用-vuex-存储的令牌" aria-hidden="true" class="header-anchor">#</a> 在需要鉴权的位置使用 vuex 存储的令牌</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// store.js</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'./axios-auth'</span><span class="token punctuation">;</span>
<span class="token comment">// store.js 导入的 axios 实例，实际上访问的是鉴权实例，不能用来获取用户数据</span>
<span class="token keyword">import</span> globalAxios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>  <span class="token comment">// 用以存储和处理用户数据</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    idToken<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">authUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>idToken <span class="token operator">=</span> userDate<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>userId <span class="token operator">=</span> userDate<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">storeUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">signup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> dispatch<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'storeUser'</span><span class="token punctuation">,</span> authData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">storeUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> store<span class="token punctuation">}</span><span class="token punctuation">,</span></span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>idToken<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      globalAxios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user.json'</span> <span class="token operator">+</span> <span class="token string">'?auth='</span> <span class="token operator">+</span> state<span class="token punctuation">.</span>idToken<span class="token punctuation">,</span> userData<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 将需要鉴权的请求移动到 store 中</span>
    <span class="token function">fetchUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> state<span class="token punctuation">}</span><span class="token punctuation">,</span></span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">.</span>idToken<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      globalAxios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user.json'</span> <span class="token operator">+</span> <span class="token string">'?auth='</span> <span class="token operator">+</span> state<span class="token punctuation">.</span>idToken<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> data <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
          <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> user <span class="token operator">=</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            user<span class="token punctuation">.</span>id <span class="token operator">=</span> key<span class="token punctuation">;</span>
            users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>user<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'storeUser'</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getters<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">user</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h3 id="访问控制-路由保护"><a href="#访问控制-路由保护" aria-hidden="true" class="header-anchor">#</a> 访问控制 / 路由保护</h3> <p>没有被鉴权就不能进入主页的路由，需要添加导航守卫，导航守卫可以在单个路由层面上设置，也可以在别的层面上设置。</p> <p>但要保护指定的路由，在单个路由层面上用较好，这样可以在加载组件前检查守卫情况。</p> <h4 id="链接重定向"><a href="#链接重定向" aria-hidden="true" class="header-anchor">#</a> 链接重定向</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store.js'</span><span class="token punctuation">;</span>
<span class="token comment">// router.js</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    component<span class="token punctuation">:</span> Home<span class="token punctuation">,</span>
    <span class="token function">beforeEnter</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在方法内检查有无令牌</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>idToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'/signin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 重定向</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="隐藏不能到达的链接"><a href="#隐藏不能到达的链接" aria-hidden="true" class="header-anchor">#</a> 隐藏不能到达的链接</h4> <ul><li>在 store 设置 getters: isAuthenticated，在存在需要根据鉴权状态显示的链接的组件中，使用 getter 获取鉴权状态，进而进行判断处理。</li></ul> <blockquote><p>为了更好的用户体验，可设置响应的 logout 登出按钮；
登出后，若需跳转到未登陆状态，可使用 <code>router.replace(url)</code> 替换到当前路由，令之不能返回，并跳转新路由。</p></blockquote> <h4 id="自动注销"><a href="#自动注销" aria-hidden="true" class="header-anchor">#</a> 自动注销</h4> <ul><li>令牌时效</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// store.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    idToken<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    userId<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">authUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>idToken <span class="token operator">=</span> userDate<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>userId <span class="token operator">=</span> userDate<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">storeUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// clearAuthData(state) {</span>
      state<span class="token punctuation">.</span>idToken <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>userId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置定时器，在令牌失效时，自动调用注销</span>
    <span class="token function">setLogoutTimer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 提交 Logout 时间到了的时候进行注销</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'logout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> expirationtime<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">signup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> dispatch<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'storeUser'</span><span class="token punctuation">,</span> authData<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'setLogoutTimer'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expiresIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> dispatch<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
      <span class="token function">axios</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'setLogoutTimer'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expiresIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="自动登录"><a href="#自动登录" aria-hidden="true" class="header-anchor">#</a> 自动登录</h4> <p>将令牌保存在 store 后，再次刷新页面，只要令牌未到期，就保持他等在上面。。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// store.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">authUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>idToken <span class="token operator">=</span> userDate<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>userId <span class="token operator">=</span> userDate<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">storeUser</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>idToken <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      state<span class="token punctuation">.</span>userId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">setLogoutTimer</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> expirationTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'logout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> expirationtime<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">signup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> dispatch<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
      axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> expiratonDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expiresIn <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ms</span>
          <span class="token comment">// 设置 token 到缓存</span>
          localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token punctuation">,</span>idToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
          localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'expiresIn'</span><span class="token punctuation">,</span> expiratonDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'storeUser'</span><span class="token punctuation">,</span> authData<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'setLogoutTimer'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>expiresIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">,</span> dispatch<span class="token punctuation">}</span><span class="token punctuation">,</span> authData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
      localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'expirationDate'</span><span class="token punctuation">)</span> <span class="token comment">// 移除某项</span>
      localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 清除全部</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">tryAutoLogin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> expirationDate <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'expiresIn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;=</span> expirationDate<span class="token punctuation">)</span>  <span class="token comment">// 令牌失效</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'authUser'</span><span class="token punctuation">,</span> userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>组件中：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在应用启动时检测用户登录状况</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'tryAutoLogin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol><li>将过期时间保存到 localStorage；</li> <li>在应用启动时检测用户登录状况；</li> <li>登出时清空 localStorage。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.aa07e3f0.js" defer></script><script src="/assets/js/2.3c3a8b86.js" defer></script><script src="/assets/js/11.087b2c37.js" defer></script>
  </body>
</html>
